name = "duratii"
main = "build/worker/shim.mjs"
compatibility_date = "2024-01-01"

[build]
command = "cargo install -q worker-build && worker-build --release"

# Durable Objects configuration
[durable_objects]
bindings = [{ name = "USER_HUB", class_name = "UserHub" }]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["UserHub"]

# D1 Database binding (development)
# Note: Using existing database, can be renamed later if needed
[[d1_databases]]
binding = "DB"
database_name = "orchestrator-db"
database_id = "d50e199d-15ce-4061-813a-20d091ddc0c2"

# R2 bucket for static assets (development)
# Note: Using existing bucket, can be renamed later if needed
[[r2_buckets]]
binding = "ASSETS"
bucket_name = "orchestrator-assets"

# Environment variables (secrets should use `wrangler secret put`)
# Required secrets (set via `wrangler secret put <NAME>`):
#   - GITHUB_CLIENT_SECRET: GitHub OAuth app secret
#   - CLOUDFLARE_ZONE_ID: Zone ID for cache purge (from Cloudflare dashboard)
#   - CLOUDFLARE_API_TOKEN: API token with Cache Purge permission
[vars]
GITHUB_CLIENT_ID = "Ov23liCmLw4EzqdaoEXD"
ALLOWED_ORGS = ""
ALLOWED_USERS = "liamhelmer"
ALLOWED_TEAMS = ""
ENVIRONMENT = "development"

# =============================================================================
# Production environment
# Deploy with: wrangler deploy --env production
# URL: https://duratii-prod.liam-helmer-428.workers.dev (or custom domain)
# =============================================================================
[env.production]
name = "duratii-prod"

[env.production.durable_objects]
bindings = [{ name = "USER_HUB", class_name = "UserHub" }]

[[env.production.migrations]]
tag = "v1"
new_sqlite_classes = ["UserHub"]

[env.production.vars]
GITHUB_CLIENT_ID = "Ov23liCmLw4EzqdaoEXD"
ALLOWED_ORGS = "epiphylic"
ALLOWED_USERS = ""
ALLOWED_TEAMS = ""
ENVIRONMENT = "production"

# Production D1 database (create with: wrangler d1 create duratii-db-prod)
[[env.production.d1_databases]]
binding = "DB"
database_name = "duratii-db-prod"
database_id = "17fe1c17-a87c-4e9e-9df3-79dc5df6ab97"

# Production R2 bucket (create with: wrangler r2 bucket create duratii-assets-prod)
[[env.production.r2_buckets]]
binding = "ASSETS"
bucket_name = "duratii-assets-prod"
